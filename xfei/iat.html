<!DOCTYPE html>

<head>
    <title>语音听写示例</title>
</head>

<body>
    <textarea id="result"></textarea>
    <br>
    <script src="http://webapi.openspeech.cn/socket.io/socket.io.js"></script>
    <script src="http://webapi.openspeech.cn/js/connection/connection.js"></script>
    <script src="http://webapi.openspeech.cn/js/audio/recorder.js"></script>
    <script src="http://webapi.openspeech.cn/js/common/resampler.js"></script>
    <script src="http://webapi.openspeech.cn/js/common/fingerprint.js"></script>
    <script src="http://webapi.openspeech.cn/js/util/brow.js"></script>
    <script src="http://webapi.openspeech.cn/js/log/log.js"></script>
    <script src="http://webapi.openspeech.cn/js/session/iat.js"></script>
    <script src="http://webapi.openspeech.cn/js/session/session.js"></script>
    <script src="http://webapi.openspeech.cn/js/session/sessioninfo.js"></script>
    <script src="http://blog.faultylabs.com/files/md5.js"></script>
    <script type="text/javascript">
    /**
     * ³õÊ¼»¯Session¶ÔÏó
     */
    var session = new Session({
        'url': 'http://webapi.openspeech.cn/ivp}',
        'interval': '30000',
        'disconnect_hint': 'disconnect',
        'sub': 'tts',
        'compress': 'speex',
        'speex_path': 'speex.js',
        'vad_path': 'vad.js',
        'recorder_path': 'recorderWorker.js'
    });

    /**
     * ¿ªÆôÂ¼Òô²¢»ñÈ¡Ê¶±ð½á¹û
     */
    function start() {
        /***********************************************************ÒÔÏÂÇ©Ãû¹ý³ÌÐè¸ù¾ÝÊµ¼ÊÓ¦ÓÃÐÅÏ¢ÌîÈë***************************************************/

        var appid = 50287829; //Ó¦ÓÃAPPID£¬ÔÚopen.voicecloud.cnÉÏÉêÇë¼´¿É»ñµÃ
        //var timestamp = $(timestamp); //µ±Ç°Ê±¼ä´Á£¬Àýnew Date().toLocaleTimeString()
		var timestamp = (new Date()).toLocaleTimeString();
        var expires = 10000; //Ç©ÃûÊ§Ð§Ê±¼ä£¬µ¥Î»:ms£¬Àý60000		
        var secret_key = '';
        //!!!Îª±ÜÃâsecretkeyÐ¹Â¶£¬Ç©Ãûº¯Êýµ÷ÓÃ´úÂë½¨ÒéÔÚ·þÎñÆ÷ÉÏÍê³É
        var signature = faultylabs.MD5(appid + '&' + timestamp + '&' + expires + '&' + secret_key);
        /************************************************************ÒÔÉÏÇ©Ãû¹ý³ÌÐè¸ù¾ÝÊµ¼ÊÓ¦ÓÃÐÅÏ¢ÌîÈë**************************************************/
        var params = {
            "grammar_list": null,
            "params": "aue=speex-wb;-1, usr = mkchen, ssm = 1, sub = iat, net_type = wifi, ent =sms16k, rst = plain, auf  = audio/L16;rate=16000, vad_enable = 1, vad_timeout = 5000, vad_speech_tail = 500, caller.appid = " + appid + ",timestamp = " + timestamp + ",expires = " + expires,
            "signature": signature
        };

        /* µ÷ÓÃ¿ªÊ¼Â¼Òô½Ó¿Ú£¬Í¨¹ýfunction(volume)ºÍfunction(err, obj)»Øµ÷ÒôÁ¿ºÍÊ¶±ð½á¹û */
        session.start('iat', params, function(volume) {
            /* »ñÈ¡²¢Õ¹Ê¾µ±Ç°Â¼ÒôÒôÁ¿ */
            if (volume < 6 && volume > 0)
                console.log("volume : " + volume);

            /* Èôvolume·µ»Ø¸ºÖµ£¬ËµÃ÷Âó¿Ë·çÆô¶¯Ê§°Ü*/
            if (volume < 0)
                console.log("Âó¿Ë·çÆô¶¯Ê§°Ü");
        }, function(err, result) {
            /* Èô»Øµ÷µÄerrÎª¿Õ»ò´íÎóÂëÎª0£¬Ôò»á»°³É¹¦£¬¿ÉÌáÈ¡Ê¶±ð½á¹û½øÐÐÏÔÊ¾*/
            if (err == null || err == undefined || err == 0) {
                if (result == '' || result == null)
                    document.getElementById('result').innerHTML = "Ã»ÓÐ»ñÈ¡µ½Ê¶±ð½á¹û";
                else
                    document.getElementById('result').innerHTML = result;
                /* Èô»Øµ÷µÄerr²»Îª¿ÕÇÒ´íÎóÂë²»Îª0£¬Ôò»á»°Ê§°Ü£¬¿ÉÌáÈ¡´íÎóÂë */
            } else {
                document.getElementById('result').innerHTML = 'error code : ' + err + ", error description : " + result;
            }
        });

    };

    function stop() {
        session.stop(null);
    };
    </script>
    <input type="button" value="Â¼Òô" onclick="start();" />
    <input type="button" value="½áÊø" onclick="stop();" />
</body>

</html>
